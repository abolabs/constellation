version: "3.8"

services:
  maildev:
    image: djfarrelly/maildev
    ports:
      - "${SMTP}:25"
      - "${WEBUI}:80"

  mariadb:
    image: mariadb:10.5
    environment:
      MARIADB_ROOT_PASSWORD: ${MARIADB_ROOT_PASSWORD}
      MARIADB_USER: ${MARIADB_USER}
      MARIADB_PASSWORD: ${MARIADB_PASSWORD}
      MARIADB_DATABASE: ${MARIADB_DATABASE}
    ports:
      - "${MARIADB_PORT-3306}:3306"
    volumes:
      - ${DATA_VOLUME}/mariadb:/var/lib/mysql

  api:
    image: registry.gitlab.com/abolabs/constellation/api:${TAG_NAME}
    volumes:
      - ./api/oauth-private.key:/var/www/constellation/api/storage/oauth-private.key
      - ./api/oauth-public.key:/var/www/constellation/api/storage/oauth-public.key
    depends_on:
      - redis
      - mariadb
      - meilisearch

  migrate:
    image: registry.gitlab.com/abolabs/constellation/api:${TAG_NAME}
    entrypoint: ["php", "artisan", "migrate"]
    depends_on:
      - mariadb
      - redis

  nginx-fpm:
    image: registry.gitlab.com/abolabs/constellation/nginx-fpm:${TAG_NAME}
    ports:
      - "${API_PORT-8080}:80"
    volumes:
      - ${DATA_VOLUME}/nginx-fpm:/var/log/nginx
      - ./nginx-fpm/default.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      - api

  web-ui:
    image: registry.gitlab.com/abolabs/constellation/web-ui:${TAG_NAME}
    ports:
      - "${HTTP-80}:80"
    volumes:
      - ./web-ui/env.config.js:/var/www/env.config.js
      - ${DATA_VOLUME}/nginx:/var/log/nginx
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      - api

  redis:
    image: redis
    ports:
      - "${REDIS_PORT-6379}:6379"
    volumes:
      - ${DATA_VOLUME}/redis:/data

  meilisearch:
    image: getmeili/meilisearch:v1.1
    environment:
      - MEILI_MASTER_KEY=${MEILI_MASTER_KEY}
    volumes:
      - ${DATA_VOLUME}/meili_data:/meili_data
    ports:
      - "${MEILI_MASTER_PORT-7700}:7700"
    depends_on:
      - mariadb
